<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Python</title>
<link href="../static/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="../static/page.css" rel="stylesheet" type="text/css"/>
<link href="../static/pygments.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<nav>
<a href="../">Home</a>
      ·
      <span class="dropdown">
<a href="#">Lessons</a>
<span class="dropdown-content" id="nav-lessons">
<a href="../01_intro/">Introduction</a>
<a href="../02_core/">Core Features</a>
<a href="../03_tools/">Tools</a>
<a href="../04_python/">Python</a>
<a href="../05_advanced/">Advanced Features</a>
<a href="../06_r/">R</a>
<a href="../07_psql/">PostgreSQL</a>
<a href="../08_finale/">Conclusion</a>
</span>
</span>
      ·
      <span class="dropdown">
<a href="#">Appendices</a>
<span class="dropdown-content" id="nav-appendices">
<a href="../license/">License</a>
<a href="../conduct/">Code of Conduct</a>
<a href="../contributing/">Contributing</a>
<a href="../bibliography/">Bibliography</a>
<a href="../glossary/">Glossary</a>
</span>
</span>
</nav>
<main>
<h1>Python</h1>
<p id="terms">Terms defined: <a class="term-defined" href="uri">Uniform Resource Identifier (URI)</a>, <a class="term-defined" href="cursor">cursor</a>, <a class="term-defined" href="orm">object-relational mapper (ORM)</a>, <a class="term-defined" href="query_builder">query builder</a></p>
<h2>Querying from Python</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">db_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select count(*) from penguins;"</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>[(344,)]
</code></pre></div>
<ul>
<li><code>sqlite3</code> is part of Python's standard library</li>
<li>Create a connection to a database file</li>
<li>Get a <a href="../glossary/#cursor">cursor</a> by executing a query<ul>
<li>More common to create cursor and use that to run queries</li>
</ul>
</li>
<li>Fetch all rows at once as list of tuples</li>
</ul>
<h2>Incremental Fetch</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">db_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select species, island from penguins limit 5;"</span><span class="p">)</span>
<span class="k">while</span> <span class="n">row</span> <span class="o">:=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
('Adelie', 'Torgersen')
</code></pre></div>
<ul>
<li><code>cursor.fetchone</code> returns <code>None</code> when no more data</li>
<li>There is also <code>fetchmany(N)</code> to fetch (up to) a certain number of rows</li>
</ul>
<h2>Insert, Delete, and All That</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"create table example(num integer);"</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"insert into example values (10), (20);"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"after insertion"</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select * from example;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"delete from example where num &lt; 15;"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"after deletion"</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select * from example;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>after insertion [(10,), (20,)]
after deletion [(20,)]
</code></pre></div>
<ul>
<li>Each <code>execute</code> is its own transaction</li>
</ul>
<h2>Interpolating Values</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"create table example(num integer);"</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">"insert into example values (?);"</span><span class="p">,</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"after insertion"</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select * from example;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>after insertion [(10,), (20,)]
</code></pre></div>
<ul>
<li>From <a href="https://xkcd.com/327/">XKCD</a></li>
</ul>
<figure id="f:python_xkcd">
<img alt="XKCD cartoon showing a mother scolding a school for not being more careful about SQL injection attacks" src="xkcd_327_exploits_of_a_mom.png"/>
<figcaption>Figure 1: XKCD "Exploits of a Mom"</figcaption>
</figure>
<h2 class="exercise">Exercise</h2>
<p>Write a Python script that takes island, species, sex, and other values as command-line arguments
and inserts an entry into the penguins database.</p>
<h2>Script Execution</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">drop table if exists example;</span>
<span class="s2">create table example(num integer);</span>
<span class="s2">insert into example values (10), (20);</span>
<span class="s2">"""</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"after insertion"</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select * from example;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>after insertion [(10,), (20,)]
</code></pre></div>
<ul>
<li>But what if something goes wrong?</li>
</ul>
<h2>SQLite Exceptions in Python</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">create table example(num integer check(num &gt; 0));</span>
<span class="s2">insert into example values (10);</span>
<span class="s2">insert into example values (-1);</span>
<span class="s2">insert into example values (20);</span>
<span class="s2">"""</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">":memory:"</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SQLite exception: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"after execution"</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select * from example;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>SQLite exception: CHECK constraint failed: num &gt; 0
after execution [(10,)]
</code></pre></div>
<h2>Python in SQLite</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">create table example(num integer);</span>
<span class="s2">insert into example values (-10), (10), (20), (30);</span>
<span class="s2">"""</span>


<span class="k">def</span><span class="w"> </span><span class="nf">clip</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">20</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">":memory:"</span><span class="p">)</span>
<span class="n">connection</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s2">"clip"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select num, clip(num) from example;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>(-10, 0)
(10, 10)
(20, 20)
(30, 20)
</code></pre></div>
<ul>
<li>SQLite calls back into Python to execute the function</li>
<li>Other databases can run Python (and other languages) in the database server process</li>
<li>Be careful</li>
</ul>
<h2>Handling Dates and Times</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>


<span class="c1"># Convert date to ISO-formatted string when writing to database</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_adapt_date_iso</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>


<span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">_adapt_date_iso</span><span class="p">)</span>


<span class="c1"># Convert ISO-formatted string to date when reading from database</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_convert_date</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>


<span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">"date"</span><span class="p">,</span> <span class="n">_convert_date</span><span class="p">)</span>

<span class="n">SETUP</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">create table events(</span>
<span class="s2">    happened date not null,</span>
<span class="s2">    description text not null</span>
<span class="s2">);</span>
<span class="s2">"""</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">":memory:"</span><span class="p">,</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SETUP</span><span class="p">)</span>

<span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
    <span class="s2">"insert into events values (?, ?);"</span><span class="p">,</span>
    <span class="p">[(</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">"started tutorial"</span><span class="p">),</span> <span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="s2">"finished tutorial"</span><span class="p">)],</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"select * from events;"</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>(datetime.date(2024, 1, 10), 'started tutorial')
(datetime.date(2024, 1, 29), 'finished tutorial')
</code></pre></div>
<ul>
<li><code>sqlite3.PARSE_DECLTYPES</code> tells <code>sqlite3</code> library to use converts based on declared column types</li>
<li>Adapt on the way in, convert on the way out</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a Python adapter that truncates real values to two decimal places
as they are being written to the database.</p>
<h2>SQL in Jupyter Notebooks</h2>
<div class="codehilite"><pre class=""><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>jupysql
</code></pre></div>
<ul>
<li>And then inside the notebook:</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code>%load_ext sql
</code></pre></div>
<ul>
<li>Loads extension</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code>%sql sqlite:///db/penguins.db
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>Connecting to 'sqlite:///data/penguins.db'
</code></pre></div>
<ul>
<li>Connects to database<ul>
<li><code>sqlite://</code> with two slashes is the protocol</li>
<li><code>/data/penguins.db</code> (one leading slash) is a local path</li>
</ul>
</li>
<li>Single percent sign <code>%sql</code> introduces one-line command</li>
<li>Use double percent sign <code>%%sql</code> to indicate that the rest of the cell is SQL</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code>%%sql
select species, count(*) as num
from penguins
group by species;
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>Running query in 'sqlite:///data/penguins.db'
</code></pre></div>
<table>
<thead>
<tr>
<th>species</th>
<th>num</th>
</tr>
</thead>
<tbody>
<tr>
<td>Adelie</td>
<td>152</td>
</tr>
<tr>
<td>Chinstrap</td>
<td>68</td>
</tr>
<tr>
<td>Gentoo</td>
<td>124</td>
</tr>
</tbody>
</table>
<h2>Pandas and SQL</h2>
<div class="codehilite"><pre class=""><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pandas
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">db_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">"select species, count(*) as num from penguins group by species;"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>     species  num
0     Adelie  152
1  Chinstrap   68
2     Gentoo  124
</code></pre></div>
<ul>
<li>Be careful about datatype conversion when using <a href="https://pandas.pydata.org/">Pandas</a></li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a command-line Python script that uses Pandas to re-create the penguins database.</p>
<h2>Polars and SQL</h2>
<div class="codehilite"><pre class=""><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>polars<span class="w"> </span>pyarrow<span class="w"> </span>adbc-driver-sqlite
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">db_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">uri</span> <span class="o">=</span> <span class="s2">"sqlite:///</span><span class="si">{db_path}</span><span class="s2">"</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">"select species, count(*) as num from penguins group by species;"</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_database_uri</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">"adbc"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>shape: (3, 2)
┌───────────┬─────┐
│ species   ┆ num │
│ ---       ┆ --- │
│ str       ┆ i64 │
╞═══════════╪═════╡
│ Adelie    ┆ 152 │
│ Chinstrap ┆ 68  │
│ Gentoo    ┆ 124 │
└───────────┴─────┘
</code></pre></div>
<ul>
<li>The <a href="../glossary/#uri">Uniform Resource Identifier</a> (URI) specifies the database</li>
<li>The query is the query</li>
<li>Use the ADBC engine instead of the default ConnectorX with <a href="https://pola.rs/">Polars</a></li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a command-line Python script that uses Polars to re-create the penguins database.</p>
<h2>Query Builders</h2>
<ul>
<li>Use <a href="https://pypika.readthedocs.io/">PyPika</a> to build queries</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pypika</span><span class="w"> </span><span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">db_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>

<span class="n">department</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">"department"</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">department</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"ident"</span><span class="p">,</span> <span class="s2">"building"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"query:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>query: SELECT "ident","building","name" FROM "department"
('gen', 'Chesson', 'Genetics')
('hist', 'Fashet Extension', 'Histology')
('mb', 'Chesson', 'Molecular Biology')
('end', 'TGVH', 'Endocrinology')
</code></pre></div>
<ul>
<li>A <a href="../glossary/#query_builder">query builder</a> creates objects representing the parts of a query<ul>
<li>Translate those objects into a SQL string for a particular dialect</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre class=""><span></span><code><span class="n">department</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">"department"</span><span class="p">)</span>
<span class="n">staff</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">"staff"</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">Query</span>\
    <span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">staff</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">department</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">staff</span><span class="o">.</span><span class="n">dept</span> <span class="o">==</span> <span class="n">department</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">staff</span><span class="o">.</span><span class="n">personal</span><span class="p">,</span> <span class="n">staff</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">department</span><span class="o">.</span><span class="n">building</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>('Divit', 'Dhaliwal', 'Fashet Extension')
('Indrans', 'Sridhar', 'Chesson')
('Pranay', 'Khanna', 'Chesson')
('Vedika', 'Rout', 'Fashet Extension')
('Abram', 'Chokshi', 'Chesson')
('Romil', 'Kapoor', 'Fashet Extension')
('Ishaan', 'Ramaswamy', 'Chesson')
('Nitya', 'Lal', 'Chesson')
</code></pre></div>
<ul>
<li>Syntax is similar to that of Pandas and Polars because:<ul>
<li>They are all solving the same basic problem</li>
<li>They all borrow ideas from each other</li>
</ul>
</li>
</ul>
<h2>Object-Relational Mappers</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sqlmodel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">SQLModel</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">select</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Department</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">building</span><span class="p">:</span> <span class="nb">str</span>


<span class="n">db_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"sqlite:///</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_uri</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Department</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>building='Chesson' name='Genetics' ident='gen'
building='Fashet Extension' name='Histology' ident='hist'
building='Chesson' name='Molecular Biology' ident='mb'
building='TGVH' name='Endocrinology' ident='end'
</code></pre></div>
<ul>
<li>An <a href="../glossary/#orm">object-relational mapper</a> (ORM) translates table columns to object properties and vice versa</li>
<li><a href="https://sqlmodel.tiangolo.com/">SQLModel</a> relies on Python type hints</li>
</ul>
<h2 class="exercise">Exercise</h2>
<p>Write a command-line Python script that uses SQLModel to re-create the penguins database.</p>
<h2>Relations with ORMs</h2>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Staff</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ident</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">personal</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">family</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">dept</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">foreign_key</span><span class="o">=</span><span class="s2">"department.ident"</span><span class="p">)</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">db_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"sqlite:///</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_uri</span><span class="p">)</span>
<span class="n">SQLModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Department</span><span class="p">,</span> <span class="n">Staff</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Staff</span><span class="o">.</span><span class="n">dept</span> <span class="o">==</span> <span class="n">Department</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dept</span><span class="p">,</span> <span class="n">staff</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">statement</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">dept</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">staff</span><span class="o">.</span><span class="n">personal</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">staff</span><span class="o">.</span><span class="n">family</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre class=""><span></span><code>Histology: Divit Dhaliwal
Molecular Biology: Indrans Sridhar
Molecular Biology: Pranay Khanna
Histology: Vedika Rout
Genetics: Abram Chokshi
Histology: Romil Kapoor
Molecular Biology: Ishaan Ramaswamy
Genetics: Nitya Lal
</code></pre></div>
<ul>
<li>Make foreign keys explicit in class definitions</li>
<li>SQLModel automatically does the join<ul>
<li>The two staff with no department aren't included in the result</li>
</ul>
</li>
</ul>
</main>
<footer>
<div class="row">
<div class="col-3 left">
	  ⇐ <a href="../03_tools/">Tools</a>
</div>
<div class="col-6 center">
<a href="../"></a>
	  © 2025
	  <a href="../#acknowledgments">the authors</a>
</div>
<div class="col-3 right">
<a href="../05_advanced/">Advanced Features</a> ⇒
	</div>
</div>
</footer>
</body>
</html>